---
title: Агрегация, обогащение с помощью LLM, фильтрация и визуализация данных о продуктах питания онлайн-магазинов с интеграцией Google Sheets
theme: default
lang: ru
download: true
---

# Агрегация, обогащение с помощью LLM, фильтрация и визуализация данных о продуктах питания онлайн-магазинов с интеграцией Google Sheets

---

## Введение в предметную область

- Рост популярности осознанного питания и трекера рациона  
- **Основные трудности:**  
  - **Трудоёмкость:** ручной сбор данных о КБЖУ  
  - **Ограниченный поиск:** нет сложной фильтрации (`белок/калории` и др.)  
  - **Скрытые характеристики:** трудно проверить кето-совместимость, лактозу и т.д.  
  - **Громоздкость:** много сайтов и категорий, медленная загрузка страниц  
- **Проблема:** отсутствует единый инструмент, который бы автоматизировал сбор, обогащение и анализ данных

---

## Проблематика и существующие решения

- **Аналоги и их недостатки**  
  - **Сайты ритейлеров (Ozon, ВкусВилл)**  
    - `+` Актуальные цены и наличие  
    - `−` Примитивные фильтры, нет сортировки по нутриентам  
  - **Счётчики калорий (FatSecret, MyFitnessPal)**  
    - `+` Удобный дневник питания  
    - `−` Нет связи с ценами и наличием, часто неточные данные  
  - **Ручные таблицы (Google Sheets/Excel)**  
    - `+` Максимальная гибкость  
    - `−` Огромные трудозатраты при заполнении  
- **Вывод:** ни одно из решений не закрывает все потребности одновременно

---

## Цель и задачи проекта

- **Цель:** разработать комплекс, который  
  - автоматически собирает данные о товарах,  
  - обогащает их диетологической информацией,  
  - предоставляет мощную фильтрацию и анализ,  
  - интегрируется с Google Sheets для планирования рациона.  
- **Ключевые задачи:**  
  1. Парсинг Ozon и ВкусВилл с обходом антибот-защиты  
  2. Обогащение данных через LLM  
  3. Веб-интерфейс с расширенной фильтрацией и пользовательскими формулами  
  4. Интеграция с Google Sheets  
  5. Шаблон таблицы для планирования рациона

---

## Задача 1. Парсинг Ozon — вызовы и решения

- **Проблемы:**  
  - Нет публичного API, строгая антибот-защита  
  - Разные форматы КБЖУ (на 100 г / на порцию)  
- **Решения:**  
  - Реверс-инжиниринг сетевых запросов → карта скрытых API-эндпоинтов  
  - Перебор параметров → найдено всё нужное  
  - На скрытых эндпоинтах нет рейт-лимита → быстрый сбор через `requests`  
  - Нормализация КБЖУ каскадом регулярных выражений  
- **Итог:** отказоустойчивый скрапер, обходящий защиту и выдающий чистые данные

---

## Задача 1. Парсинг ВкусВилл — вызовы и решения

- **Отличия от Ozon:**  
  - `+` Мягкие рейт-лимиты → параллельный сбор  
  - `−` Полное отсутствие API  
- **Проблема:** КБЖУ и состав спрятаны в тексте описания  
- **Решение:** каскад регулярных выражений с валидацией и fallback-парсингом  
- **Результат:** структурированные данные из «грязного» HTML с высокой точностью

---

## Проверка цены и наличия по адресу

- **Задача:** цена и наличие зависят от адреса (cookies)  
- **Трудности:** API Ozon не принимает внешние cookies  
- **Решение:** Selenium + Playwright  
  1. Однократный видимый браузер → выбор адреса  
  2. Сохранение cookies в файл  
  3. Headless-проверки с инъекцией cookies  
- **Итог:** надёжная автоматизированная проверка актуальной цены и наличия

---

## Задача 2. Обогащение данных LLM

- **Проблема:** «Сырые» данные не отвечают на вопросы кето-совместимости, FODMAP и т.д.  
- **Решение:** Google Gemini API + Pydantic-схемы  
  ```python
  class ProductAI(BaseModel):
      fodmap_rating: int = Field(..., ge=1, le=5)
      keto_rating:   int = Field(..., ge=1, le=5)
      gluten_rating: int = Field(..., ge=1, le=5)
      # ещё 30+ полей
  ```
- Промпт с JSON-схемой → 96 % корректных ответов  
- Асинхронный конвейер `asyncio.Semaphore(3)` обходится в rate-limit  
- **Выход:** десятки новых атрибутов для гибкой фильтрации

---

## Задача 3. Веб-интерфейс анализа

- **Стек:** React + Vite, Tailwind CSS, Node.js (Express)  
- **Интерактивная таблица:** виртуализация тысяч строк, мгновенные фильтры  
- Скрытие/перетаскивание столбцов, запуск проверки наличия из UI  
- **Фишка:** пользовательские формулы сортировки  
  - Пример: `protein / calories * 100` → «самые белковые» продукты

---

## Задача 4. Интеграция с Google Sheets

- **Цель:** перенос выбранных продуктов в план питания одним кликом  
- **Технология:** Express-бэкенд проксирует Google Sheets API через сервисный аккаунт  
- Кнопка «Экспорт» в каждой строке → бесшовная отправка данных  
- **Результат:** сквозной сценарий «нашёл → добавил в рацион»

---

## Задача 5. Шаблон Google Sheets

- **Лист «База продуктов»:** пополняется из веб-интерфейса  
- **Лист «План на неделю»:** выпадающие списки, автоматический расчёт КБЖУ и стоимости  
- Формулы `SUMIF`, `VLOOKUP` подбивают итоги по дню и неделе  
- Бесплатно, работает на любом устройстве, привычный UX Sheets

---

## Архитектура системы

- **Принципы:** модульность, loose-coupling через CSV  
- **Конвейер:**  
  ```
  Парсинг → Миграция → Обогащение → Веб-интерфейс
  ```
- **Скрипт миграции:**  
  ```python
  def migrate_data(mode='update'):
      for scraper in ['ozon', 'vkusvill']:
          for csv in find_csvs(scraper):
              merge(csv, f'csv/{scraper}.csv', mode)
  ```
- Backup и rollback перед обновлениями  
- **Split-Tunneling:** RU-сайты напрямую, Google API через VPN

---

## Выводы и результаты

- **Цель достигнута:** комплекс ускоряет поиск и планирование рациона в разы  
- **Технические достижения:**  
  1. Парсинг защищённых сайтов без API  
  2. LLM-конвейер с 30+ новыми атрибутами на товар  
  3. Аналитический UI с пользовательскими формулами  
  4. Экспорт в Google Sheets + готовый шаблон планировщика  
- **Практическая ценность:**   
  - Часы ручной работы превращаются в минуты  
  - Обнаружены уникальные продукты (творог 55 ккал/100 г и др.)  
- **Спасибо за внимание!**